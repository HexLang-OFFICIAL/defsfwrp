<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NSFW RP Chat with WebGPU & WebLLM</title>
  <script src="https://mlc.ai/web-llm/dist/index.js"></script>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 1rem;
      display: flex; flex-direction: column; height: 100vh;
    }
    #chatlog {
      flex: 1;
      overflow-y: auto;
      background: #222;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    #input-area {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    input[type="text"] {
      flex: 1;
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 4px;
      border: none;
    }
    select, button {
      padding: 0.5rem 1rem;
      background: #333;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    select {
      min-width: 150px;
    }
    img.avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 0.5rem;
      vertical-align: middle;
    }
    .chat-entry {
      margin-bottom: 0.8rem;
      display: flex;
      align-items: center;
    }
    .chat-entry .message {
      background: #444;
      padding: 0.5rem 1rem;
      border-radius: 12px;
      max-width: 70%;
    }
    .chat-entry.user .message {
      background: #0a84ff;
      color: white;
      margin-left: auto;
    }
  </style>
</head>
<body>

  <h1>üî• NSFW RP Chat (WebGPU + WebLLM)</h1>

  <div id="chatlog"></div>

  <div id="input-area">
    <select id="character-select"></select>
    <input type="text" id="user-input" placeholder="Say something dirty..." />
    <button id="send-btn">Send</button>
    <button id="save-btn" title="Save Chat">üíæ</button>
    <button id="load-btn" title="Load Chat">üìÇ</button>
  </div>

  <script>
    const characters = {
      Succubus: {
        prompt: "You are a seductive succubus who loves naughty, detailed roleplay. Stay in character and tease the user.",
        avatar: "https://i.imgur.com/YkV9spW.png" // replace with actual avatar URL
      },
      Yandere: {
        prompt: "You are a jealous, obsessive lover who says anything to keep the user's attention, sometimes scary but playful.",
        avatar: "https://i.imgur.com/ogQOjw5.png"
      },
      Maid: {
        prompt: "You are a loyal maid who obeys your master's requests, always polite and slightly naughty.",
        avatar: "https://i.imgur.com/ITmfiBx.png"
      },
      Himbo: {
        prompt: "You're a hot, clueless flirt who just wants to please the user with silly but sexy remarks.",
        avatar: "https://i.imgur.com/2v7E5qK.png"
      }
    };

    let chatHistory = [];
    let model;
    const chatlog = document.getElementById("chatlog");
    const characterSelect = document.getElementById("character-select");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const saveBtn = document.getElementById("save-btn");
    const loadBtn = document.getElementById("load-btn");

    // Populate character dropdown
    for (const charName in characters) {
      const opt = document.createElement("option");
      opt.value = charName;
      opt.textContent = charName;
      characterSelect.appendChild(opt);
    }

    // Show chat entries
    function appendChat(role, message, avatarURL) {
      const div = document.createElement("div");
      div.classList.add("chat-entry");
      if (role === "user") div.classList.add("user");

      const avatarImg = document.createElement("img");
      avatarImg.src = avatarURL || "https://i.imgur.com/7k0cP1F.png"; // default avatar
      avatarImg.classList.add("avatar");

      const msgSpan = document.createElement("div");
      msgSpan.classList.add("message");
      msgSpan.textContent = message;

      div.appendChild(avatarImg);
      div.appendChild(msgSpan);

      chatlog.appendChild(div);
      chatlog.scrollTop = chatlog.scrollHeight;
    }

    // Save and load chat from localStorage
    saveBtn.onclick = () => {
      localStorage.setItem("nsfwChatHistory", JSON.stringify(chatHistory));
      alert("Chat saved! üíæ");
    };

    loadBtn.onclick = () => {
      const saved = localStorage.getItem("nsfwChatHistory");
      if (!saved) return alert("No saved chat found.");
      chatHistory = JSON.parse(saved);
      chatlog.innerHTML = "";
      for (const entry of chatHistory) {
        const avatar = entry.role === "ai" ? characters[entry.character].avatar : null;
        appendChat(entry.role === "ai" ? entry.character : "user", entry.message, avatar);
      }
    };

    // Initialize WebLLM and load model
    async function init() {
      chatlog.innerHTML = "<em>Loading model... ‚è≥</em>";
      model = await webllm.createChatWorker("TinyLlama-1.1B-Chat-q4f32_1");
      chatlog.innerHTML += "<div><em>Model ready ‚úÖ</em></div>";
    }

    async function sendMessage() {
      const input = userInput.value.trim();
      if (!input) return;
      userInput.value = "";

      // Show user message
      appendChat("user", input, "https://i.imgur.com/7k0cP1F.png");

      // Add user message to history
      chatHistory.push({ role: "user", message: input });

      // Compose context for the model
      const characterName = characterSelect.value;
      const characterPrompt = characters[characterName].prompt;

      // Build messages with memory (last 6 messages max)
      let messages = [
        { role: "system", content: characterPrompt }
      ];

      // Add last 6 messages to conversation for context (user + AI)
      let recent = chatHistory.slice(-6 * 2); // approx 6 rounds (user + AI)
      // Build messages with roles
      for (let i = 0; i < recent.length; i++) {
        let entry = recent[i];
        if (entry.role === "user") messages.push({ role: "user", content: entry.message });
        else if (entry.role === "ai") messages.push({ role: "assistant", content: entry.message });
      }

      // Query model
      const response = await model.chat.completions.create({ messages });

      const reply = response.choices[0].message.content.trim();

      // Add AI reply to history
      chatHistory.push({ role: "ai", message: reply, character: characterName });

      // Show AI reply
      appendChat(characterName, reply, characters[characterName].avatar);
    }

    sendBtn.onclick = sendMessage;
    userInput.addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });

    // Start loading
    init();
  </script>
</body>
</html>
